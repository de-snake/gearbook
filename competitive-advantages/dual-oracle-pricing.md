# Dual-oracle pricing

Gearbox oracle and solvency checks structure allows creating pricing methods with unique features:

* Attract borrowers using hardcoded/ fundamental oracles + protect LPs by always taking market price into account.
* Ensure timely liquidations using market oracles + protect LPs by always taking collateral fundamental value into account.

### Dual-oracle system

Gearbox operates with 2 feeds for each collateral: _**Main**_ feed and _**Reserve**_ one.\
Main feed is used for for Account Value calculation during Liquidation checks.

Reserve oracles provide an additional security layer to protect liquidity providers (LPs) from oracle manipulation risks, ensuring accurate collateral valuations.

Reserve oracle is used during collateral checks in multicalls, which is a mechanism to perform complex defi interactions from credit accounts in single transaction.\
The multicalls are introduced on the Credit Accounts page, see below:

{% embed url="https://app.gitbook.com/o/-MVf0w9QBIQw5nuscwFc/s/-MV2P3lqKrTIf58BQE1v/~/changes/540/overview/credit-account#multicalls" fullWidth="false" %}

In particular, **Reserve** price feed is involved when the multicall includes **Collateral Withdrawal** or **External Calls** through adapters. The collateral check after such operations prices each collateral using the Safe Price:

$$
Safe\ Price = min(Main\ Feed\ Price, Reserve\ Feed\ Price)
$$

#### Why does it matter?&#x20;

Oracles are crucial for determining collateral value in lending protocols. Unlike simple exchanges (e.g., Uniswap), lending protocols rely heavily on external data. Risks include:

* &#x20;**Node compromise:** Hackers could gain control of oracle nodes, submitting incorrect data. Popular oracles often rely on 4-5 nodes, selecting median values; compromising 2 or 3 of them can significantly distort reported prices.
* **Thin liquidity manipulation:** Oracles aggregate prices from various trading sources (DEXes, CEXes). In cases of low liquidity and infrequent trades, malicious actors can temporarily inflate asset prices. For example, manipulating a short-duration TWAP (e.g., 4 minutes) can lead to artificially high collateral valuations, as recently observed with Chainlink.

### Pricing methodologies

There are two main methodologies of pricing tokens that is used in most of the lending markets:

* **Hardcoded/ Fundamental/ Backing Value/ Exhange Rate**\
  It has multiple names, but the basic idea is to price the token based on reserves that back it
* **Secondary market price**\
  Price at which token is bought and sold on DEXes, CEXes or any other liquid market.

<table><thead><tr><th width="163.31640625">Feed type</th><th width="265.55859375" valign="top">Pros</th><th width="345.36328125" valign="top">Cons</th></tr></thead><tbody><tr><td>Hardcoded Fundamental<br>Backing Value Exhange Rate</td><td valign="top"><strong>Borrowers:</strong><br>- Minimal risks of liquidation<br>- Up-to-date reflection of staked collateral price appreciation<br><strong>Lenders:</strong><br>- Resistant to market manipulation, important for illiquid tokens</td><td valign="top"><strong>Lenders:</strong><br>- Possible overpricing during hacks and market turmoils</td></tr><tr><td>Secondary market price</td><td valign="top"><strong>Lenders:</strong><br>- Pessimistic pricing (liquid tokens usually trade at discount to their backing value)</td><td valign="top"><strong>Borrowers:</strong><br>- Less capital-efficient: have to maintain higher HF to avoid liquidations<br>- Can cause cascading liquidations<br><strong>Lenders:</strong><br>- Illiquid collateral markets can be manipulated to drain pool reserves at inflated price</td></tr></tbody></table>

### Dual-Oracle system: best of both worlds

Let's compare how properly configured **Main** and **Reserve** feeds can protect lenders while preserving exceptional UX and capital efficiency for borrowers by studying multiple market cases. In the table below, the case when some collateral token is used to borrow blue-chip stablecoin such as USDC.

| Scenario                                                                      | Dual-Oracle system                                                                                                                                                                                                                                                                                                                                         | Hardcoded feed                                                                                                                                                                                                                                                                                                                                                                                 | Market feed                                                                                                                                                                                                                                                                                                                                                                                                            |
| ----------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| sUSDe/USD market price drops by >2.5%                                         | <mark style="background-color:green;">No liquidations of existing positions</mark>                                                                                                                                                                                                                                                                         | <mark style="background-color:green;">No liquidations of existing positions</mark>                                                                                                                                                                                                                                                                                                             | <mark style="background-color:orange;">Risky positions liquidated</mark>                                                                                                                                                                                                                                                                                                                                               |
| <p>(paranoid)<br>USDe/USD market price drops by >10%</p>                      | <p><mark style="background-color:orange;">No liquidations of existing positions</mark><br><br><mark style="background-color:green;">Safe price = min(market, hardcoded) = $0.9</mark><br><br><mark style="background-color:green;">Can borrow $0.915 per USDe, but can't withdraw it from credit account ⇒ liquidity doesn't exit the protocol.</mark></p> | <p><mark style="background-color:orange;">No liquidations of existing positions</mark><br><br><mark style="background-color:red;">Attack vector:</mark><br><mark style="background-color:red;">- buy at $0.9</mark><br><mark style="background-color:red;">- borrow $0.915 at max LTV (e.g. 91.5%)</mark><br><mark style="background-color:red;">TVL lent is used as exit liquidity</mark></p> | <mark style="background-color:red;">Major part of positions liquidated</mark>                                                                                                                                                                                                                                                                                                                                          |
| deUSD/USD market price pumps by >2.5%                                         | <mark style="background-color:green;">No liquidations of existing positions</mark>                                                                                                                                                                                                                                                                         | <mark style="background-color:green;">No liquidations of existing positions</mark>                                                                                                                                                                                                                                                                                                             | <mark style="background-color:green;">No liquidations of existing positions</mark>                                                                                                                                                                                                                                                                                                                                     |
| <p>(illiquid market manipulation)<br>deUSD/USD market price pumps by >10%</p> | <p><mark style="background-color:green;">No liquidations of existing positions</mark><br><br><mark style="background-color:green;">Can borrow $1.02 per deUSD, but can't withdraw it from credit account ⇒ liquidity doesn't exit the protocol.</mark></p>                                                                                                 | <mark style="background-color:green;">No liquidations of existing positions</mark>                                                                                                                                                                                                                                                                                                             | <p><mark style="background-color:green;">No liquidations of existing positions</mark></p><p></p><p><mark style="background-color:red;">Attack vector:</mark><br><mark style="background-color:red;">- mint deUSD at $1</mark><br><mark style="background-color:red;">- borrow $1.02 at max LTV (e.g. 92.5%)</mark></p><p><br><mark style="background-color:red;">TVL lent drained due to inflated valuation</mark></p> |

### Custom Feeds contracts to price all the DeFi

The Gearbox Oracle contract supports major price feed providers, including Chainlink, Redstone (both pull and push models), and Pyth. These providers are referred to as _external_ because their data often comes from off-chain sources (e.g., centralized exchanges) or requires off-chain computation applied to on-chain data.

Integrating tokens with these external providers can be costly and slow. To address this, Gearbox developers created modular, reusable Price Feed contracts to efficiently price DeFi collaterals. For example:

* **wstETH/USD Pricing**: While most providers offer an ETH/USD price feed, not every one provide a wstETH/USD feed. Gearbox’s [wstETH Price Feed contract](https://permissionless.gearbox.foundation/bytecode/hash/0x1470bbd8dde923d15199f70a7735968c91ddbbf00fdaea1c1f6b31fa35ee0d10) solves this by using the ETH/USD feed from an external provider, retrieving the wstETH/stETH exchange rate directly from the wstETH contract, and multiplying these to calculate the wstETH/USD price.
* **Exotic DeFi Collaterals**: The modular design of Gearbox’s Price Feed contracts enables pricing for more complex DeFi tokens, such as Mellow rstETH, Treehouse tETH, and other ERC4626-compatible tokens with wstETH as the vault’s underlying asset. For instance, an [ERC4626 Price Feed contract](https://permissionless.gearbox.foundation/bytecode/hash/0x05fb7084afc898b54ae4206ca860091a87feaeba0e143cf075a11526af0e667c) retrieves the rstETH/wstETH exchange rate directly from the vault and multiplies it by the wstETH/USD price (already calculated) to determine the token’s value.

This modular pricing approach extends to other DeFi collaterals, such as Pendle PT tokens and Curve LP tokens, with dedicated Price Feed contracts already implemented. For a complete list of Price Feed contracts, refer to the the Gearbox Bytecode Repository:

{% embed url="https://permissionless.gearbox.foundation/bytecode" %}
